{% extends "base.html" %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', path='/css/style.css') }}" type="text/css">
    <link rel="stylesheet" href="{{ url_for('static', path='/css/searchlabel.css') }}" type="text/css">
    <title>ラベル登録確認</title>
    <style>
        .form-container, .preview-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .form-group { margin-bottom: 15px; }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input[type="text"],
        .form-group input[type="url"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-group textarea { height: 120px; font-family: monospace; }
        .form-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        .form-actions button, .form-actions a.button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            color: white;
            text-align: center;
        }
        .btn-primary { background-color: #007bff; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-success { background-color: #28a745; }
        .btn-success:hover { background-color: #218838; }
        .btn-info { background-color: #17a2b8; }
        .btn-info:hover { background-color: #138496; }

        #preview-result { margin-top: 20px; }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
            margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #message-area {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            display: none;
        }
        .message-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* ダークモード対応 */
        @media (prefers-color-scheme: dark) {
            .form-container, .preview-container { background-color: #2d2d2d; box-shadow: 0 2px 4px rgba(0,0,0,0.5); }
            .form-group label { color: #e0e0e0; }
            .form-group input, .form-group select, .form-group textarea {
                background-color: #3c3c3c;
                color: #e0e0e0;
                border-color: #555;
            }
            .message-success { background-color: #1a3c23; color: #c3e6cb; border-color: #2f663d; }
            .message-error { background-color: #491f22; color: #f5c6cb; border-color: #843534; }
        }

        /* プレビュー結果テーブル用のスタイル */
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .preview-table th, .preview-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            vertical-align: top;
        }
        .preview-table th {
            background-color: #f2f2f2;
        }
        .preview-table pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 0;
        }

        /* プレビュー結果カード用のスタイル */
        .preview-cards-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        .preview-card {
            border: 1px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
            width: 220px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        .preview-card a {
            text-decoration: none;
            color: inherit;
        }
        .card-image-container {
            position: relative;
            width: 100%;
            padding-top: 100%; /* 1:1 アスペクト比 */
        }
        .card-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            background-color: #f0f0f0;
        }
        .card-sitename {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
        }
        .card-info {
            padding: 10px;
            font-size: 0.9em;
            flex-grow: 1;
        }
        .card-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .card-sub-urls {
            padding: 0 10px 10px;
            font-size: 0.8em;
        }
        #preview-result h4 a {
            word-break: break-all;
        }

    </style>
{% endblock %}

{% block body %}
<div class="container">
    <h1>
        {% if is_edit_mode %}ラベル編集{% else %}ラベル登録確認{% endif %}
    </h1>

    <div id="message-area"></div>

    <form id="label-confirm-form">
        <div class="form-container">
            <div class="form-group">
                {% if is_edit_mode %}
                {# 編集モードの場合、更新対象のIDを保持 #}
                <input type="hidden" id="id" name="id" value="{{ preview.id }}">
                {% endif %}
                <label for="label_name">ラベル名</label>
                <input type="text" id="label_name" name="label_name" value="{{ preview.label_name }}" required>
            </div>
            <div class="form-group">
                <label for="base_url">ベースURL</label>
                <input type="url" id="base_url" name="base_url" value="{{ preview.base_url }}" required>
            </div>
            <div class="form-group">
                <label for="query">クエリ</label>
                <input type="text" id="query" name="query" value="{{ preview.query }}" required>
            </div>
            <div class="form-group">
                <label for="query_encoding">クエリエンコーディング</label>
                <input type="text" id="query_encoding" name="query_encoding" value="{{ preview.query_encoding }}" required>
            </div>
            <div class="form-group">
                <label for="download_type">ダウンロードタイプ</label>
                <input type="text" id="download_type" name="download_type" value="{{ preview.download_type }}">
            </div>
            <div class="form-group">
                <label for="download_config">ダウンロード設定 (JSON)</label>
                <textarea id="download_config" name="download_config">{{ preview.download_config | tojson_japanese(indent=2) }}</textarea>
            </div>
        </div>

        <div class="preview-container">
            <h2>プレビュー用設定</h2>
            <div class="form-group">
                <label for="learning_url">学習URL</label>
                <input type="url" id="learning_url" name="learning_url" value="{{ preview.learning_url or '' }}">
            </div>
            <div class="form-group">
                <label for="target_urls">対象URL (改行区切り)</label>
                <textarea id="target_urls" name="target_urls">{{ (preview.target_urls or []) | join('\n') }}</textarea>
            </div>
            <div class="form-group">
                <label for="keywords">キーワード (改行区切り)</label>
                <textarea id="keywords" name="keywords">{{ (preview.keywords or []) | join('\n') }}</textarea>
            </div>
        </div>
    </form>

    <div class="form-actions">
        <div>
            {% if is_edit_mode %}
            <a href="{{ url_for('read_labels') }}" class="button btn-secondary">一覧に戻る</a>
            {% else %}
            <a href="{{ url_for('read_labels_add') }}" class="button btn-secondary">入力に戻る</a>
            {% endif %}
            <a href="{{ url_for('read_labels') }}" class="button btn-info">ラベル一覧</a>
        </div>
        <div>
            {% set register_text = '登録' %}
            {% if is_edit_mode %}{% set register_text = '更新' %}{% endif %}

            <button id="register-btn" type="button" class="button btn-success" onclick="registerLabel()">プレビューせずに{{ register_text }}</button>
            <button id="preview-btn" type="button" class="button btn-primary" onclick="runPreview()">プレビュー（時間がかかります）</button>
            <button id="register-with-preview-btn" type="button" class="button btn-success" onclick="registerLabel()" style="display: none;">この結果で{{ register_text }}</button>
        </div>
    </div>

    <div id="preview-result-area" class="preview-container" style="display: none;">
        <h2>プレビュー結果</h2>
        <div id="preview-result"></div>
    </div>
</div>

<script>
    const previewBtn = document.getElementById('preview-btn');
    const registerBtn = document.getElementById('register-btn');
    const registerWithPreviewBtn = document.getElementById('register-with-preview-btn');
    const previewResultArea = document.getElementById('preview-result-area');
    const previewResultDiv = document.getElementById('preview-result');
    const messageArea = document.getElementById('message-area');
    const isEditMode = {{ is_edit_mode | tojson }};

    function getFormData(isForPreview) {
        const form = document.getElementById('label-confirm-form');
        const formData = new FormData(form);
        const data = {};

        for (let [key, value] of formData.entries()) {
            data[key] = value;
        }

        // download_configはJSON文字列からオブジェクトに変換
        try {
            // 空文字列の場合はパースしない
            if (data.download_config && data.download_config.trim()) {
                data.download_config = JSON.parse(data.download_config);
            }
        } catch (e) {
            console.error("Invalid JSON in download_config:", e);
            data.download_config = {};
        }

        if (isForPreview) {
            // 改行区切りのテキストを配列に変換
            data.target_urls = document.getElementById('target_urls').value.split('\n').filter(Boolean);
            data.keywords = document.getElementById('keywords').value.split('\n').filter(Boolean);
        }

        return data;
    }

    function createPreviewCards(data) {
        if (!data.results || Object.keys(data.results).length === 0) {
            return '<p>プレビュー結果はありませんでした。</p>';
        }

        const baseUrl = document.getElementById('base_url').value;
        let origin = '';
        try {
            origin = new URL(baseUrl).origin;
        } catch (e) {
            console.error("Invalid base_url for creating absolute sub_urls:", baseUrl);
        }

        let html = '';

        for (const [targetUrl, searchResults] of Object.entries(data.results)) {
            html += `<h4>対象URL: <a href="${targetUrl}" target="_blank" rel="noopener noreferrer">${targetUrl}</a></h4>`;

            if (searchResults.error_msg) {
                html += `<p><strong style="color: red;">エラー:</strong> ${searchResults.error_msg}</p>`;
                continue;
            }

            if (!searchResults.results || searchResults.results.length === 0) {
                html += '<p>取得データなし</p>';
                continue;
            }

            html += '<div class="preview-cards-container">';
            for (const item of searchResults.results) {
                const title = item.title || 'タイトルなし';
                const condition = item.condition ? ` ${item.condition}` : '';
                const price = item.price ? `${item.price.toLocaleString()}円` : '';
                const taxin = item.taxin ? ' (税込)' : '';
                const stockMsg = item.stock_msg || '';
                const imageUrl = item.image_url || ''; // ダミー画像
                const itemUrl = item.url || '#';

                html += `
                    <div class="preview-card">
                        <a href="${itemUrl}" target="_blank" rel="noopener noreferrer">
                            <div class="card-image-container">
                                <img src="${imageUrl}" alt="${title}" class="card-image" loading="lazy">
                                ${item.sitename ? `<span class="card-sitename">${item.sitename}</span>` : ''}
                            </div>
                        </a>
                        <div class="card-info">
                            <div class="card-title">${title}</div>
                            <div>${condition}</div>
                            <div>${price}${taxin}</div>
                            <div>${stockMsg}</div>
                        </div>
                        ${item.sub_urls && item.sub_urls.length > 0 ? `
                        <div class="card-sub-urls">
                            ${item.sub_urls.map(subUrl => {
                                const finalUrl = (subUrl && subUrl.startsWith('/') && origin) ? `${origin}${subUrl}` : subUrl;
                                return `<a href="${finalUrl}" target="_blank" rel="noopener noreferrer">サブリンク</a>`;
                            }).join(' ')}
                        </div>
                        ` : ''}
                    </div>
                `;
            }
            html += '</div>';
        }
        return html;
    }

    async function runPreview() {
        const learningUrl = document.getElementById('learning_url').value.trim();
        if (!learningUrl) {
            showMessage('プレビューを実行するには学習URLを入力してください。', 'error');
            window.scrollTo(0, 0);
            return;
        }

        previewBtn.disabled = true;
        previewBtn.textContent = 'プレビュー実行中...';
        previewResultArea.style.display = 'block';
        previewResultDiv.innerHTML = '<div class="spinner"></div>';

        const requestData = getFormData(true);

        try {
            const response = await fetch("{{ url_for('post_labels_preview') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.detail || 'プレビューに失敗しました。');
            }

            previewResultDiv.innerHTML = createPreviewCards(result);
            registerWithPreviewBtn.style.display = 'inline-block';
            previewBtn.textContent = '再プレビュー';

        } catch (error) {
            previewResultDiv.innerHTML = `<p style="color: red;">エラー: ${error.message}</p>`;
        } finally {
            previewBtn.disabled = false;
        }
    }

    async function registerLabel() {
        const buttons = [previewBtn, registerBtn, registerWithPreviewBtn].filter(Boolean);
        buttons.forEach(btn => btn.disabled = true);

        const requestData = getFormData(false);
        // プレビュー用のキーは削除
        delete requestData.learning_url;
        delete requestData.target_urls;
        delete requestData.keywords;

        const url_update_template = "{{ url_for('update_label', id='__LABEL_ID__') }}";
        const url = isEditMode ?  url_update_template.replace('__LABEL_ID__', requestData.id) : "{{ url_for('post_labels') }}";
        const method = isEditMode ? 'PUT' : 'POST';
        const successMessage = isEditMode ? 'ラベルを更新しました。一覧ページに移動します...' : 'ラベルを登録しました。一覧ページに移動します...';
        const errorMessageBase = isEditMode ? '更新' : '登録';

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            });

            const result = await response.json();

            if (!response.ok) {
                // FastAPIのHTTPExceptionからのエラーメッセージを取得
                const detail = result.detail || JSON.stringify(result);
                throw new Error(`${errorMessageBase}に失敗しました: ${detail}`);
            }
            if (!result.success) {
                throw new Error(result.message || `${errorMessageBase}に失敗しました。`);
            }

            showMessage(successMessage, 'success');
            window.scrollTo(0, 0);
            // 2秒後にラベル一覧ページにリダイレクト
            setTimeout(() => {
                window.location.href = "{{ url_for('read_labels') }}"; // 常に一覧へ
            }, 2000);

        } catch (error) {
            showMessage(`エラー: ${error.message}`, 'error');
            window.scrollTo(0, 0);
            buttons.forEach(btn => btn.disabled = false); // エラー時はボタンを再度有効化
        }
    }

    function showMessage(message, type) {
        messageArea.textContent = message;
        messageArea.className = `message-${type}`;
        messageArea.style.display = 'block';
    }

</script>
{% endblock %}